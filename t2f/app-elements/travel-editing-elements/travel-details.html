<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/etools-repeatable-field-set/etools-repeatable-field-set.html">
<link rel="import" href="../../../bower_components/etools-searchable-multiselection-menu/etools-searchable-multiselection-menu.html">

<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../travel-status-box/travel-status.html">
<link rel="import" href="../../app-behaviors/permission-behavior.html">
<link rel="import" href="../field-set-elements/travel-plan.html">

<link rel="import" href="../field-set-elements/travel-activity.html">
<link rel="import" href="../field-set-elements/travel-itinerary.html">
<link rel="import" href="../field-set-elements/travel-expense.html">

<link rel="import" href="../../styles/shared-styles.html">
<link rel="import" href="../../styles/et2f-styles.html">

<link rel="import" href="../field-set-elements/travel-costs-assignment.html">
<link rel="import" href="../field-set-elements/travel-deductions.html">
<link rel="import" href="../field-set-elements/travel-costs-summary.html">

<link rel="import" href="../datepicker-input/datepicker-input.html">

<dom-module id="travel-details">
  <template>
    <style include="shared-styles et2f-styles iron-flex iron-flex-alignment iron-flex-factors">
     :host {
        display: block;
        width: 100%;
      }
      .dialog-heading {
          font-size: 20px;
          color: var(--gray-dark);
          font-weight: 500;
      }
      .dialog-intro-text {
          color: var(--gray-mid);
          font-size: 16px;
          margin-bottom: 24px;
      }
      .missing-action {
        color: var(--et2f-warning);
        text-align: center;
        font-size: 16px;
        font-weight: 500;
      }
      .dialog-confirm-button {
          color: var(--et2f-primary);
          font-weight: 500;
          height: 40px;
          float: right;
      }
      etools-repeatable-field-set {
        width: calc( 100% - 48px);
        margin: 24px;
        --repeatable-items-collapse-container: {
          background: #FFF;
        };
      }
      .orange-header {
        --repeatable-items-header-bg: var(--et2f-warning);
      }
      .note {
        margin: 24px;
        padding: 24px 24px 24px 64px;
      }
      .note-heading {
        margin-bottom: 24px;
        font-weight: 500;
        font-size: 14px;
      }
      .cancel {
        border-top: 2px solid var(--et2f-warning);
      }
      .cancel .note-heading { color: var(--et2f-warning); }
      .reject {
        border-top: 2px solid var(--et2f-error);
      }
      .reject .note-heading { color: var(--et2f-error); }
      .note-text {
        color: var(--gray-dark);
      }
      .flag {
        position: absolute;
        top: -4px;
        left: 18px;
      }
      .cancel-flag {
        fill: var(--et2f-warning);
      }
      .reject-flag {
        fill: var(--et2f-error);
      }
    </style>

    <div class="horizontal layout">

      <div class="flex">

        <paper-dialog id="invalid_modal" with-backdrop>

          <div class="dialog-heading">Warning</div>
          <div class="dialog-intro-text">You are not allowed to take this action, until you have missing, or badly formatted information in the following fields:</div>

          <template is="dom-repeat" items="[[invalids]]">
            <div class="missing-action">[[item]]</div>
          </template>

          <paper-button
            class="dialog-confirm-button"
            on-click="closeInvalidModal">
              I understand
          </paper-button>
        </paper-dialog>

        <!-- Cancellation note -->
        <paper-material class="note cancel" elevation="1" hidden$="[[_hideCancelNote(data)]]">
          <svg class="flag" width="24px" height="49px" viewBox="0 0 24 49">
            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
              <g class="cancel-flag" transform="translate(-96.000000, -226.000000)" fill="#FF9044">
                <g transform="translate(80.000000, 226.000000)">
                  <polygon points="16 0 40 0 40 49 28 39 16 49"></polygon>
                </g>
              </g>
            </g>
          </svg>
          <div class="note-heading">CANCELLATION NOTE</div>
          <div class="note-text">[[data.cancellation_note]]</div>
        </paper-material>

        <!-- Rejection note -->
        <paper-material class="note reject" elevation="1" hidden$="[[_hideRejectionNote(data)]]">
          <svg class="flag" width="24px" height="49px" viewBox="0 0 24 49">
            <g  stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
              <g class="reject-flag" transform="translate(-96.000000, -226.000000)" fill="#FF9044">
                <g transform="translate(80.000000, 226.000000)">
                  <polygon points="16 0 40 0 40 49 28 39 16 49"></polygon>
                </g>
              </g>
            </g>
          </svg>
          <div class="note-heading">REJECTION NOTE</div>
          <div class="note-text">[[data.rejection_note]]</div>
        </paper-material>

        <!-- Certification note -->
        <paper-material class="note reject" elevation="1" hidden$="[[_hideCertificationNote(data)]]">
          <svg class="flag" width="24px" height="49px" viewBox="0 0 24 49">
            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
              <g class="reject-flag" transform="translate(-96.000000, -226.000000)" fill="#FF9044">
                <g transform="translate(80.000000, 226.000000)">
                  <polygon points="16 0 40 0 40 49 28 39 16 49"></polygon>
                </g>
              </g>
            </g>
          </svg>
          <div class="note-heading">CERTIFICATION NOTE</div>
          <div class="note-text">[[data.certification_note]]</div>
        </paper-material>

        <etools-repeatable-field-set title="Trip Plan"
          hide-plus
          show-counter="[[false]]"
          model="[1]"
          hide-vertical-divider
          elevation="1">

          <travel-plan id="travel_plan"
            base-details="{{data.baseDetails}}"
            permissions-matrix="[[travelPermissions.baseDetails]]"
            structure="[[structure]]"
            user="[[user]]">
          </travel-plan>
        </etools-repeatable-field-set>

        <etools-repeatable-field-set title="Trip Activities"
          id="activities"
          model="{{data.activities}}"
          hide-plus="[[!sectionPermissions.activities.edit]]"
          allow-copy="[[sectionPermissions.activities.edit]]"
          show-counter
          elevation="1"
          open="[[sectionPermissions.activities.open]]"
          hidden$="[[sectionPermissions.activities.hidden]]">

          <template
            is="dom-repeat"
            items="{{data.activities}}"
            strip-whitespace>

            <travel-activities
              class="travel_activity"
              activity="{{item}}"
              permissions-matrix="[[travelPermissions.activities]]"
              structure="[[structure]]"
              activity-validation-array="{{activityValidationArray}}">
            </travel-activities>
          </template>
        </etools-repeatable-field-set>

        <etools-repeatable-field-set title="Itinerary"
          id="itinerary"
          model="{{data.itinerary}}"
          hide-plus="[[!sectionPermissions.itinerary.edit]]"
          allow-copy="[[sectionPermissions.itinerary.edit]]"
          elevation="1"
          show-counter
          open="[[sectionPermissions.itinerary.open]]"
          hidden$="[[sectionPermissions.itinerary.hidden]]">

          <template
            is="dom-repeat"
            items="{{data.itinerary}}">

            <travel-itinerary permissions-matrix="[[travelPermissions.itinerary]]"
              itinerary="{{item}}"
              structure="[[structure]]">
            </travel-itinerary>
          </template>
        </etools-repeatable-field-set>

        <etools-repeatable-field-set title="Deductions"
          id="deductions"
          hide-vertical-divider
          model="[1]"
          hide-plus
          elevation="1"
          open="[[sectionPermissions.deductions.open]]"
          hidden$="[[sectionPermissions.deductions.hidden]]">

          <div class="layout vertical flex">

            <travel-deductions
              disabled="[[!sectionPermissions.deductions.open]]"
              itinerary="[[data.itinerary]]"
              deductions="{{data.deductions}}"
              permissions-matrix="[[travelPermissions.deductions]]">
            </travel-deductions>
          </div>
        </etools-repeatable-field-set>

        <etools-repeatable-field-set title="Expenses"
          id="expenses"
          model="{{data.expenses}}"
          show-counter
          hide-plus="[[!sectionPermissions.expenses.edit]]"
          elevation="1"
          open="[[sectionPermissions.expenses.open]]"
          hidden$="[[sectionPermissions.expenses.hidden]]">

          <template is="dom-repeat" items="{{data.expenses}}">
            <travel-expense permissions-matrix="[[travelPermissions.expenses]]"
              expense="{{item}}"
              structure="[[structure]]">
            </travel-expense>
          </template>
        </etools-repeatable-field-set>

        <etools-repeatable-field-set title="Cost Assignment"
          id="cost_assignments"
          model="{{data.cost_assignments}}"
          elevation="1"
          hide-plus="[[!sectionPermissions.cost_assignments.edit]]"
          open="[[sectionPermissions.cost_assignments.open]]"
          hidden$="[[sectionPermissions.cost_assignments.hidden]]">

          <template is="dom-repeat" items="{{data.cost_assignments}}">

            <travel-cost-assignment permissions-matrix="[[travelPermissions.cost_assignments]]"
              cost-assignment="{{item}}"
              structure="[[structure]]">
            </travel-cost-assignment>

          </template>
        </etools-repeatable-field-set>

        <etools-repeatable-field-set title="Cost summary"
          id="cost_summary"
          hide-vertical-divider
          class="orange-header"
          model="[1]"
          hide-plus
          elevation="1"
          open="[[sectionPermissions.cost_summary.open]]"
          hidden$="[[sectionPermissions.cost_summary.hidden]]">

          <travel-cost-summary cost-summary="[[data.cost_summary]]" currency="[[data.baseDetails.currency]]" structure="[[structure]]"></travel-cost-summary>
        </etools-repeatable-field-set>
      </div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'travel-details',
      properties: {
        data: {
          type: Object,
          notify: true,
        },
        structure: {
          type: Object,
        },
        travelPermissions: {
          type: Object,
        },
        sectionPermissions: {
          type: Object,
          computed:
            '_computeSectionPermissions(travelPermissions,' +
              ' data.baseDetails.international_travel, data.status, userRoles)'
        },
        invalids: Array,
        userRoles: {
          type: Array,
        },
        activityValidationArray: {
          type: Array,
          value: []
        },
        scrollToFieldset: {
          type: String,
          observer: '_scrollTo'
        },
        user: Object
      },
      _computeSectionPermissions: function(permissions, isInternational, status, userRoles) {
        var computed = {};

        var collapsedStatus = {
          'Traveler': {
            'Sent for payment': ['deductions', 'expenses', 'cost_assignments'],
            'Certification submitted': ['deductions', 'expenses', 'cost_assignments'],
            'Certification approved': ['deductions', 'expenses', 'cost_assignments'],
            'Certification rejected': ['deductions', 'expenses', 'cost_assignments'],
            'Certified': ['deductions', 'expenses', 'cost_assignments'],
            'Completed': ['deductions', 'expenses', 'cost_assignments'],
          },
          'Travel Administrator': {
            'Canceled': ['deductions', 'expenses', 'cost_assignments'],
            'Submitted': ['deductions', 'expenses', 'cost_assignments'],
            'Sent for payment': ['deductions', 'expenses', 'cost_assignments'],
            'Certification submitted': ['deductions', 'expenses', 'cost_assignments'],
            'Certification approved': ['deductions', 'expenses', 'cost_assignments'],
            'Certification rejected': ['deductions', 'expenses', 'cost_assignments'],
            'Certified': ['deductions', 'expenses', 'cost_assignments'],
            'Completed': ['deductions', 'expenses', 'cost_assignments'],
          },
          'Supervisor': {
            'Canceled': ['deductions', 'expenses', 'cost_assignments'],
            'Submitted': ['deductions', 'expenses', 'cost_assignments'],
            'Sent for payment': ['deductions', 'expenses', 'cost_assignments'],
            'Approved': ['deductions', 'expenses', 'cost_assignments'],
            'Rejected': ['deductions', 'expenses', 'cost_assignments'],
          },

        };

        var hiddenForInternational = [
          'expenses',
          'cost_assignments',
          'deductions',
          'cost_summary'
        ];
        var collapseRule = userRoles.find(function(role) {
          return Object.keys(collapsedStatus).indexOf(role) > -1;
        });
        var hiddenFieldSet = collapseRule ?
          collapsedStatus[collapseRule][status] ? collapsedStatus[collapseRule][status] : [] : [];

        Object.keys(permissions).forEach(function(key) {
          var forceHiddenStatus = false;
          if (isInternational) {
            forceHiddenStatus = hiddenForInternational.indexOf(key) > -1;
          }

          computed[key] = {
            hidden: !permissions[key].view || forceHiddenStatus,
            open: hiddenFieldSet.indexOf(key) === -1,
            edit: permissions[key].edit
          };
        });
        return computed;
      },

      _scrollTo: function(fieldset) {
        this.$[fieldset].scrollIntoView();
      },

      _hideCancelNote: function(data) {
        return data.status !== 'Cancelled' || data.cancellation_note.length === 0;
      },

      _hideRejectionNote: function(data) {
        return data.status !== 'Rejected' || data.rejection_note.length === 0;
      },

      _hideCertificationNote: function(data) {
        return data.status !== 'Certification submitted';
      },

      doValidate: function(e, action) {

        var invalids = [];

        if (['Save', 'Print TA', 'Cancel', 'Mark as planned'].indexOf(action.name) < 0) {

          // Validating Trip plan
          if (!this.$.travel_plan._validateTravelPlan()) {
            invalids.push('Trip Plan');
          }

          // Validating Activities
          if (!this.sectionPermissions.activities.hidden) {
            var allActivitiesValid = true;
            this.data.activities.forEach(function(act) {
              allActivitiesValid = act._validationFunction() && allActivitiesValid;
            });
            if (!allActivitiesValid) {
              invalids.push('Trip Activities');
            }
          }

          // Validating Expenses
          if (!this.sectionPermissions.expenses.hidden) {
            var expensesAreValid = true;
            this.data.expenses.forEach(function(exp) {
              expensesAreValid = exp._validationFunction() && expensesAreValid;
            });
            if (!expensesAreValid) {
              invalids.push('Expenses');
            }
          }
        }

        if (invalids.length) {

          this.set('invalids', invalids);
          this.$.invalid_modal.open();

        } else {

          this.fire('form-action', action);
        }
      },

      closeInvalidModal: function() {
        this.$.invalid_modal.close();
      }

    });
  </script>
</dom-module>
